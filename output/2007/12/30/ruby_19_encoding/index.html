<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>yob.id.au: Ruby 1.9 and Encodings</title>
    <link rel="alternate" type="application/atom+xml" title="Atom" href="/atom/index.xml" />
    <style type="text/css" media="screen">
      * {
        margin: 0;
        padding: 0;
      
        font-family: Georgia, Palatino, Times, 'Times New Roman', sans-serif;
      }
      
      body {
        background: #fff;
      }
      
      a {
        text-decoration: none;
      }
      
      a:link,
      a:visited {
        color: #f30;
      }
      
      a:hover {
        color: #f90;
      }
      
      #main {
        position: absolute;
      
        top: 20px;
        left: 280px;
      
        width: 500px;
      }
      
      #main h1 {
        font-size: 40px;
        font-weight: normal;
      
        line-height: 40px;
      
        padding: 20px 0 20px 0;
      
        letter-spacing: -1px;
      }
      
      #main p {
        margin: 0 0 20px 0;
        
        font-size: 15px;
        
        line-height: 20px;
      }
      
      #main ul {
        padding: 0 0 0 20px;
      }
      
      #main li {
        margin: 0 0 20px 0;
      
        list-style-type: square;
      
        font-size: 15px;
        
        line-height: 20px;
      }
      
      #sidebar {
        position: absolute;
      
        top: 40px;
        left: 20px;
        width: 200px;
      
        padding: 20px 20px 0 0;
      
        border-right: 1px solid #ccc;
      
        text-align: right;
      }
      
      #sidebar h2 {
        text-transform: uppercase;
      
        font-size: 13px;
      
        color: #333;
      
        letter-spacing: 1px;
      
        line-height: 20px;
      }
      
      #sidebar ul {
        list-style-type: none;
      
        margin: 20px 0;
      }
      
      #sidebar li {
        font-size: 14px;
      
        line-height: 20px;
      }
    </style>
  </head>
  <body>
    <div id="main">
      <h1>Ruby 1.9 and Encodings</h1>
<p><a href="http://www.ruby-lang.org/en/news/2007/12/25/ruby-1-9-0-released/">Ruby 1.9</a>
was released last week, and I've been poking around with the changes to the
String class to see what's possible. 1.9 is a development release, so I'm not
planning to start using it in production anytime soon, but it's nice to be able
to test my apps for compatibility with the planned 2.0 release.</p>

<p>In ruby &lt;= 1.8, strings were effectively just byte streams. Those bytes would
often contain text in one encoding or another, but there was no formal way to
record exactly which one (if any; binary data has none). All the default
methods assumed single byte encoding (such as US-ASCII), so behaviour was odd
when the encoding was multibyte (such as UTF8).</p>

<p>1.9 now records the encoding of a string, which allows many of the methods to
be improved to recognise multi-byte strings. For further background on
encodings, read Joel Spolsky's
<a href="http://www.joelonsoftware.com/articles/Unicode.html">article</a>.</p>

<p>Consider the following UTF-8 string:</p>

<pre><code>str = "メインページ"

str.encoding
=&gt; #&lt;Encoding:UTF-8&gt;
</code></pre>

<p>The size method now returns the size of the string in characters, not bytes. To
get the size in bytes, use the bytesize method.</p>

<pre><code>str.bytesize
=&gt; 18

str.size
=&gt; 6
</code></pre>

<p>To check if the string contains only ASCII compatible characters, regardless of
the encoding:</p>

<pre><code>str.ascii_only?
=&gt; false
</code></pre>

<p>If Ruby has confused itself and has the wrong encoding recorded, you can
forcibly fix it. The bytestream will not be modified, just ruby's understanding
of what the stream represents.</p>

<pre><code>str.force_encoding("ASCII")
=&gt; "\xE3\x83\xA1\xE3\x82\xA4\xE3\x83\xB3\xE3\x83\x9A\xE3\x83\xBC\xE3\x82\xB8" 

str.size
=&gt; 18

str.bytesize
=&gt; 18

str.force_encoding("UTF-8")
=&gt; "メインページ"
</code></pre>

<p>Some encodings can be translated to others: the underlying bytestream will be
changed to represent the same characters in the new encoding. The output of the
following examples won't render correctly as your browser will be interpreting
this page as UTF-8:</p>

<pre><code>str.encode!("Shift_JIS")
=&gt; "���C���y�[�W"
str.bytesize
=&gt; 12

str.encode!("EUC-JP")
=&gt; "�ᥤ���ڡ���"
str.bytesize
=&gt; 12

str.encode!("UTF-8")
=&gt; "メインページ"
str.bytesize
=&gt; 18
</code></pre>

<p>If you try to encode a string into an encoding for which there are no
equivalent characters (ie. a UTF-8 string with Hebrew characters into
Shift-JIS), then a runtime exception will be raised.</p>

<p>To view the encodings available on the system:</p>

<pre><code>Encoding.list
=&gt; [#&lt;Encoding:ASCII-8BIT&gt;, #&lt;Encoding:EUC-JP&gt;, #&lt;Encoding:Shift_JIS&gt;, #&lt;Encoding:UTF-8&gt;, #&lt;Encoding:ISO-2022-JP (dummy)&gt;]
</code></pre>

<p>To set the default encoding to use in your scripts, use the following magic comment on the first line (or second if the first starts with #!):</p>

<pre><code># coding: utf-8
</code></pre>

<p>If you are reading in a file that is encoded differently to your default, you
can specify what to use when opening it:</p>

<pre><code>File.open("/home/jh/downloads/UTF-8-demo.txt", "r:UTF-8") { |f| puts f.gets; puts f.gets; puts f.gets }
</code></pre>

<p>All this encoding sugar makes for a promising future for Ruby's international
support. I see it being useful in a few of the libraries I maintain to ensure
developers pass in strings with the correct encoding.</p>

<p>For a more detailed look at the encoding support in 1.9, I highly recommend to
chapter on encoding in the <a href="http://www.pragprog.com/titles/ruby3">3rd Edition of the
pickaxe</a>.</p>
    </div>
    <div id="sidebar">
      <h2>Pages</h2>
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="/archive">archive</a></li>
        <li><a href="/about">about</a></li>
      </ul>
      <h2>Syndication</h2>
      <ul>
        <li><a href="/atom/index.xml">atom</a></li>
      </ul>
    </div>
  </body>
</html>
